<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deck Primer Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        canvas {
            border: 1px solid #000;
            margin: 10px;
        }
    </style>
</head>
<body>
    <h1>Deck Primer Generator</h1>
    <form id="deckForm">
        <label for="deckUrl">Moxfield Deck URL:</label>
        <input type="text" id="deckUrl" name="deckUrl" required>
        <button type="submit">Generate Primer</button>
    </form>
    <canvas id="frontCanvas" width="350" height="500"></canvas>
    <canvas id="backCanvas" width="350" height="500"></canvas>

    <script>
        document.getElementById('deckForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const deckUrl = document.getElementById('deckUrl').value;
            const deckId = deckUrl.split('/').pop();

            try {
                const response = await fetch(`https://api2.moxfield.com/v2/decks/all/${deckId}`);
                const deckData = await response.json();

                const deckName = deckData.name;
                const commander = deckData.commanders[0].name;
                const bracket = deckData.bracket;
                const gamechangers = deckData.gamechangers;
                const tutors = deckData.tutors;
                const basics = deckData.basics.length;
                const totalLands = deckData.lands.length;
                const description = deckData.description;

                const scryfallResponse = await fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(commander)}`);
                const scryfallData = await scryfallResponse.json();
                const commanderImage = scryfallData.image_uris.art_crop;
                const artistName = scryfallData.artist;

                const frontCanvas = document.getElementById('frontCanvas');
                const frontCtx = frontCanvas.getContext('2d');

                const backCanvas = document.getElementById('backCanvas');
                const backCtx = backCanvas.getContext('2d');

                const commanderImg = new Image();
                commanderImg.src = commanderImage;
                commanderImg.onload = function() {
                    frontCtx.clearRect(0, 0, frontCanvas.width, frontCanvas.height);
                    frontCtx.font = '16px Arial';
                    frontCtx.fillText(`Deck Name: ${deckName}`, 10, 30);
                    frontCtx.drawImage(commanderImg, 10, 50, 330, 200);
                    frontCtx.fillText(`Artist: ${artistName}`, 10, 270);
                    frontCtx.fillText(`Commander: ${commander}`, 10, 300);
                    frontCtx.fillText(`Bracket: ${bracket}`, 10, 330);
                    frontCtx.fillText(`${gamechangers.length} Gamechangers: ${gamechangers}`, 10, 360);
                    frontCtx.fillText(`${tutors.length} Tutors: ${tutors}`, 10, 390);
                    frontCtx.fillText(`Basics: ${basics}`, 10, 420);
                    frontCtx.fillText(`Total Lands: ${totalLands}`, 10, 450);

                    backCtx.clearRect(0, 0, backCanvas.width, backCanvas.height);
                    backCtx.font = '16px Arial';
                    backCtx.fillText(`Deck Description:`, 10, 30);
                    backCtx.fillText(description, 10, 60, 330);
                    QRCode.toCanvas(backCanvas, deckUrl, { width: 100, margin: 1 }, function(error) {
                        if (error) console.error(error);
                        console.log('QR code generated!');
                    });
                };

            } catch (error) {
                console.error('Error fetching deck data:', error);
            }
        });
    </script>
</body>
</html>
